#include "aout.h"
#include "kernel/user.h"
#include "memory/kmalloc.h"
#include "kernel/kernel.h"
#include "kernel/tty.h"
#include <stdint.h>

#define SIZE 277
// #define SIZE 157

char pr[SIZE] = { 0x07, 0x01, 0x86, 0x00, 0x12, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x55, 0x89, 0xe5, 0xa1, 0x00, 0x00, 0x00, 0x00, 0x83, 0xc0, 0x0a, 0xa3, 0x00, 0x00, 0x00, 0x00,
 0xeb, 0xf1, 0x05, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x64, 0x77, 0x61, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00,
 0x00, 0x00, 0x06, 0x00, 0x00, 0x04, 0x0c, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x04, 0x04, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x16, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1b, 0x00,
 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1d, 0x00, 0x00, 0x00, 0x07, 0x00,
 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x1f, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x08, 0x00,
 0x00, 0x00, 0x22, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x27, 0x00,
 0x00, 0x00, 0x61, 0x2e, 0x63, 0x70, 0x70, 0x00, 0x2e, 0x74, 0x65, 0x78, 0x74, 0x00, 0x2e, 0x64,
 0x61, 0x74, 0x61, 0x00, 0x2e, 0x62, 0x73, 0x73, 0x00, 0x61, 0x00, 0x63, 0x00, 0x63, 0x68, 0x00,
 0x6d, 0x61, 0x69, 0x6e, 0x00 };

// char pr[SIZE] = {
// 	0x07, 0x01, 0x86, 0x00, 0x23, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
// 0x00, 0x00, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
// 0x00, 0x00, 0x00, 0x00, 0x55, 0x89, 0xe5, 0x83, 0xec, 0x10, 0xc7, 0x45, 0xfc, 0x01, 
// 0x00, 0x00, 0x00, 0xeb, 0x04, 0x83, 0x45, 0xfc, 0x01, 0x81, 0x7d, 0xfc, 0xe8, 0x03, 
// 0x00, 0x00, 0x75, 0xf3, 0xb8, 0x00, 0x00, 0x00, 0x00, 0xc9, 0xc3, 0x04, 0x00, 0x00, 
// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 
// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
// 0x00, 0x00, 0x00, 0x00, 0x00, 0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
// 0x00, 0x00, 0x00, 0x19, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
// 0x00, 0x1e, 0x00, 0x00, 0x00, 0x61, 0x2e, 0x63, 0x00, 0x2e, 0x74, 0x65, 0x78, 0x74, 
// 0x00, 0x2e, 0x64, 0x61, 0x74, 0x61, 0x00, 0x2e, 0x62, 0x73, 0x73, 0x00, 0x6d, 0x61, 
// 0x69, 0x6e, 0x00
// };

uint32_t read(int fd, void* src, uint32_t size)
{
	static uint32_t red = 0;
	uint32_t cnt = 0;
	char* dst = (char*)src;
	while (red < SIZE && cnt < size)
	{
		dst[cnt++] = pr[red++];
	}
	return cnt;
}

void jmp(void *eip, void *esp) 
{
	__asm volatile(
    "movl %%ebx, %%esp\n"
    "pushl %%eax\n"
    "ret\n"
    :
    : "eax"(eip), "ebx"(esp)
    :
                 );
  	__builtin_unreachable();
}

void exec(int fd)
{
	struct exec ex;
	int red = 0;
	while ((red += read(fd, (void*)&ex + red, sizeof(ex) - red)) < sizeof(ex));
	if (red != sizeof(ex))
	{
		terminal_writestring("Not red all of it\n");
		return; // assert
	}
	if ((ex.a_midmag & 0xffff) != MAGIC1) // MAGIC constant in a.out. In mans it is written,
	{									  // that they are 0407 (it is octal) or smth like that.
		terminal_writestring("Not right MAGIC number\n");
		return; // assert					
	}
	int pid = init_user_allocator();
	void* top = kmalloc(MY_STACK_SIZE, user_allocator); // maybe should be replaced with syscall for segmentation of code
	top += MY_STACK_SIZE * PAGE_SIZE;
	int cdseg_size = (ex.a_text + ex.a_data + PAGE_SIZE - 1) / PAGE_SIZE; // code_data_segment_size
	void* cdseg = kmalloc(cdseg_size, user_allocator);
	red = 0;
	int to_read = ex.a_text + ex.a_data;
	while ((red += read(fd, (void*)cdseg + red, to_read - red)) < to_read);
	jmp(cdseg, top);
	// memcpy from file to memory and jump. it is easy, of course 
}